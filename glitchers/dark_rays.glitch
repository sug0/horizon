max := func(x, y) {
    return x > y ? x : y
}

// check if we saved last values
if !ctx.r {
    ctx.r = pixel[0]
    ctx.g = pixel[1]
    ctx.b = pixel[2]
}

pixel[0] = x & i64(1.5*f64(max(pixel[0], pixel[1]) - ctx.r))
pixel[1] = y & i64(1.5*f64(max(pixel[1], pixel[2]) - ctx.g))
pixel[2] = x & i64(1.5*f64(max(pixel[2], pixel[0]) - ctx.b))
